<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iron Fx Recovery</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #090909;
      color: #fff;
    }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .main-container {
      flex: 1;
      display: flex;
      min-height: 0;
    }
    aside {
      width: 200px;
      background: #18191a;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      z-index: 10;
      border-right: 1px solid #272727;
    }
    .sidebar-logo {
      padding: 32px 0 16px 0;
      text-align: center;
    }
    .sidebar-logo img {
      width: 90px;
      border-radius: 20px;
    }
    nav.sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 10px 0;
    }
    nav.sidebar-nav button, nav.sidebar-nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: none;
      border: none;
      color: #fff;
      text-align: left;
      font-size: 1.07em;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: background 0.18s, color 0.18s, border-color 0.2s;
      outline: none;
      border-radius: 0 16px 16px 0;
      font-weight: bold;
    }
    nav.sidebar-nav button.active, nav.sidebar-nav a.active {
      background: #232629;
      border-left: 3px solid #ff0000;
      color: #ff0000;
    }
    nav.sidebar-nav button:hover:not(.active), nav.sidebar-nav a:hover:not(.active) {
      background: #232323;
      color: #ff6363;
    }
    .logout-btn {
      margin: 20px 20px 20px 20px;
      align-self: flex-end;
      width: auto;
      padding: 5px 16px;
      font-size: 0.95em;
      background: #232323;
      color: #ff6363;
      border: 1px solid #444;
      border-radius: 8px;
      transition: background 0.2s, color 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .logout-btn:hover {
      background: #ff0000;
      color: #fff;
    }
    header {
      background: #ff0000;
      text-align: center;
      padding: 14px 0 12px 200px;
      font-size: 1.45em;
      font-weight: bold;
      letter-spacing: .5px;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .content {
      margin-left: 200px;
      max-width: 900px;
      width: 100%;
      min-height: 80vh;
      padding: 40px 24px 20px 24px;
      box-sizing: border-box;
      display: block;
    }
    .panel {
      background: #151516;
      border-radius: 18px;
      box-shadow: 0 2px 30px #22000022;
      padding: 28px 24px;
      max-width: 400px;
      margin: auto;
      margin-bottom: 24px;
    }
    .panel h2 {
      margin-top: 0;
      color: #ff0000;
      letter-spacing: .5px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 1em;
      margin-bottom: 2px;
      color: #eee;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      background-color: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 1em;
    }
    .panel button, .panel input[type="submit"] {
      background-color: #ff0000;
      border: none;
      cursor: pointer;
      font-weight: bold;
      border-radius: 8px;
      transition: background 0.18s;
      width: 100%;
      margin-top: 18px;
      padding: 10px 0;
      font-size: 1.09em;
    }
    .panel button:hover, .panel input[type="submit"]:hover {
      background-color: #d10000;
    }
    .msg {
      margin-top: 10px;
      font-size: 1em;
      text-align: center;
    }
    .msg.success {
      color: #0f0;
    }
    .msg.error {
      color: #f00;
    }
    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
    }
    .users-table th, .users-table td {
      border: 1px solid #292929;
      padding: 8px 5px;
      text-align: left;
      font-size: .97em;
    }
    .users-table th {
      background: #2c2c2c;
      color: #ff6363;
    }
    .users-table tr:nth-child(even) {
      background: #191919;
    }
    .users-table tr.approved {
      background: #123c12;
      color: #92ffa1;
    }
    .users-table tr.rejected {
      background: #3c1212;
      color: #ffa192;
    }
    .admin-actions button {
      margin-right: 8px;
      margin-bottom: 2px;
      width: auto;
      padding: 5px 12px;
      font-size: .95em;
      background: #232323;
      color: #fff;
      border-radius: 7px;
      border: 1px solid #444;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      outline: none;
    }
    .admin-actions button.approve { color: #0f0; border-color: #0f0; }
    .admin-actions button.reject { color: #f00; border-color: #f00; }
    .admin-actions button:hover {
      background: #ff0000;
      color: #fff;
    }
    /* Trading area stylings */
    .trading-board {
      background: #191e20;
      border-radius: 20px;
      box-shadow: 0 2px 12px #2226;
      padding: 20px;
      margin-bottom: 18px;
      max-width: 600px;
      margin: auto;
      margin-bottom: 30px;
    }
    .trading-board .price {
      font-size: 2.1em;
      margin-bottom: 10px;
      font-family: 'Courier New', monospace;
    }
    .trading-board .price.up { color: #0f0; }
    .trading-board .price.down { color: #f00; }
    .trading-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-top: 15px;
    }
    .trading-actions button {
      width: 120px !important;
      padding: 12px 0 !important;
      border-radius: 10px;
      font-size: 1.15em;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
      transition: background 0.18s;
    }
    .btn-buy { background: #0c0; color: #fff; }
    .btn-buy:hover { background: #19a819; }
    .btn-sell { background: #f00; color: #fff; }
    .btn-sell:hover { background: #b40000; }
    .operations-panel {
      background: #181919;
      border-radius: 14px;
      box-shadow: 0 2px 12px #2226;
      margin: 0 auto 18px auto;
      padding: 20px;
      max-width: 600px;
    }
    .operations-panel h3 {
      margin: 0 0 10px 0;
      color: #ff6363;
      font-size: 1.1em;
    }
    .operations-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .99em;
    }
    .operations-table th, .operations-table td {
      border: 1px solid #242424;
      padding: 7px 4px;
      text-align: center;
    }
    .operations-table th {
      background: #202223;
      color: #ff6363;
    }
    .operations-table tr.buy {background: #122c12;}
    .operations-table tr.sell {background: #2c1212;}
    .operations-table tr.closed {opacity: .65;}
    .bottom-bar {
      position: fixed;
      left: 0;
      bottom: 0;
      width: 100%;
      background: #17181a;
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 12px 0 8px 0;
      z-index: 99;
      border-top: 1px solid #333;
    }
    .bottom-bar button {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.15em;
      padding: 6px 17px;
      border-radius: 9px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      transition: background 0.12s, color 0.12s;
      font-weight: bold;
    }
    .bottom-bar button.active, .bottom-bar button:focus {
      background: #232323;
      color: #ff0000;
    }
    .bottom-bar button:hover:not(.active) {
      background: #222;
      color: #ff6363;
    }
    .bottom-bar i {
      font-size: 1.32em;
    }
    @media (max-width: 700px) {
      aside { width: 56px; }
      .sidebar-logo img { width: 38px; }
      .sidebar-logo { padding: 16px 0 9px 0; }
      nav.sidebar-nav button, nav.sidebar-nav a {
        font-size: 0.92em;
        padding: 12px 8px;
        border-radius: 0 9px 9px 0;
        gap: 5px;
      }
      .content { margin-left: 56px; padding: 16px 5px 75px 5px; }
      header { padding-left: 56px; font-size: 1em; }
      .trading-board, .operations-panel { max-width: 97vw; }
      .panel { max-width: 97vw; }
    }
    @media (max-width: 480px) {
      .bottom-bar button span {display:none;}
      .bottom-bar button i {font-size:1.2em;}
    }
  </style>
</head>
<body>
<aside id="sidebar" style="display:none;">
  <div class="sidebar-logo">
    <img src="icon-192.png" alt="Iron FX Logo">
  </div>
  <nav class="sidebar-nav" id="nav-menu">
    <button type="button" data-section="trading"><i class="fa-solid fa-chart-line"></i> Trading</button>
    <button type="button" data-section="admin" id="adminPanelBtn" style="display:none;"><i class="fa-solid fa-user-shield"></i> Panel Admin</button>
  </nav>
  <button id="logout-btn" class="logout-btn" title="Cerrar sesión"><i class="fa-solid fa-right-from-bracket"></i></button>
</aside>

<header>
  Iron Fx Recovery
</header>

<main class="main-container">
  <section class="content" id="content-area">
    <!-- Login / Registro -->
    <div id="login-panel" class="panel" style="max-width:430px;">
      <h2>Iniciar Sesión</h2>
      <form id="form-login">
        <div class="form-group">
          <label for="login-email">Correo electrónico</label>
          <input type="email" id="login-email" placeholder="ejemplo@correo.com" required>
        </div>
        <div class="form-group">
          <label for="login-password">Contraseña</label>
          <input type="password" id="login-password" placeholder="********" required>
        </div>
        <button type="submit">Entrar</button>
        <div class="msg" id="login-msg"></div>
      </form>
      <div style="margin-top:12px;text-align:center;">
        <small>¿No tienes cuenta? <a href="#" id="show-register" style="color:#ff6363;cursor:pointer;">Regístrate aquí</a></small>
      </div>
    </div>

    <div id="register-panel" class="panel" style="display:none;max-width:430px;">
      <h2>Registrarse</h2>
      <form id="form-register">
        <div class="form-group">
          <label for="reg-email">Correo electrónico</label>
          <input type="email" id="reg-email" required>
        </div>
        <div class="form-group">
          <label for="reg-password">Contraseña</label>
          <input type="password" id="reg-password" required>
        </div>
        <div class="form-group">
          <label for="reg-nombre">Nombre completo</label>
          <input type="text" id="reg-nombre" required>
        </div>
        <button type="submit">Registrarme</button>
        <div class="msg" id="register-msg"></div>
      </form>
      <div style="margin-top:12px;text-align:center;">
        <small>¿Ya tienes cuenta? <a href="#" id="show-login" style="color:#ff6363;cursor:pointer;">Inicia sesión</a></small>
      </div>
    </div>

    <!-- Secciones principales -->
    <div id="trading" style="display:none;">
      <div class="trading-board">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div>
            <span style="font-weight:bold;font-size:1.1em;">EUR/USD</span>
            <span style="font-size:0.92em;color:#aaa;">(Simulado)</span>
          </div>
          <div id="simu-balance" style="font-size:1em;color:#44ff44;font-weight:bold;">Balance: $10000</div>
        </div>
        <div id="simu-price" class="price">1.1000</div>
        <div class="trading-actions">
          <button class="btn-buy" id="btnBuy"><i class="fa-solid fa-arrow-up"></i> Comprar</button>
          <button class="btn-sell" id="btnSell"><i class="fa-solid fa-arrow-down"></i> Vender</button>
        </div>
      </div>
      <div class="operations-panel">
        <h3>Operaciones abiertas</h3>
        <table class="operations-table" id="operations-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Precio</th>
              <th>Monto</th>
              <th>P/L</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS renderiza operaciones -->
          </tbody>
        </table>
      </div>
      <div class="panel" style="max-width:600px;">
        <h2>Depósito y Retiro</h2>
        <form id="form-deposito" style="margin-bottom:16px;">
          <div style="display:flex;gap:10px;">
            <div class="form-group" style="flex:1;">
              <label for="pais-deposito">País</label>
              <select id="pais-deposito" required>
                <option value="">--Selecciona--</option>
                <option>Colombia</option>
                <option>Perú</option>
                <option>México</option>
              </select>
            </div>
            <div class="form-group" style="flex:1;">
              <label for="monto-deposito">Monto (USD)</label>
              <input type="number" id="monto-deposito" placeholder="Ej: 100" min="1" required>
            </div>
          </div>
          <button type="submit"><i class="fa-solid fa-circle-plus"></i> Depositar</button>
          <div class="msg" id="deposito-msg"></div>
        </form>
        <form id="form-retiro">
          <div style="display:flex;gap:10px;">
            <div class="form-group" style="flex:1;">
              <label for="banco">Banco</label>
              <input type="text" id="banco" placeholder="Banco" required>
            </div>
            <div class="form-group" style="flex:1;">
              <label for="cuenta">Cuenta</label>
              <input type="text" id="cuenta" placeholder="Cuenta o tarjeta" required>
            </div>
            <div class="form-group" style="flex:1;">
              <label for="pais-retiro">País</label>
              <select id="pais-retiro" required>
                <option value="">--Selecciona--</option>
                <option>Colombia</option>
                <option>Perú</option>
                <option>México</option>
              </select>
            </div>
            <div class="form-group" style="flex:1;">
              <label for="monto-retiro">Monto (USD)</label>
              <input type="number" id="monto-retiro" placeholder="Ej: 50" min="1" required>
            </div>
          </div>
          <button type="submit"><i class="fa-solid fa-circle-minus"></i> Retirar</button>
          <div class="msg" id="retiro-msg"></div>
        </form>
      </div>
    </div>

    <!-- Panel admin -->
    <div id="admin" style="display:none;">
      <div class="panel" style="max-width:900px;">
        <h2>Panel de Administración</h2>
        <p>Usuarios registrados pendientes de aprobación:</p>
        <table class="users-table" id="admin-users-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Nombre</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS renderiza aquí -->
          </tbody>
        </table>
        <div class="msg" id="admin-msg"></div>
      </div>
    </div>
  </section>
</main>

<footer>
  &copy; 2025 Iron Fx Recovery. Todos los derechos reservados.
</footer>

<div class="bottom-bar" id="bottom-bar" style="display:none;">
  <button type="button" id="bottom-tab-trading" class="active"><i class="fa-solid fa-chart-line"></i> <span>Trading</span></button>
  <button type="button" id="bottom-tab-deposit"><i class="fa-solid fa-circle-plus"></i> <span>Depósito</span></button>
  <button type="button" id="bottom-tab-withdraw"><i class="fa-solid fa-circle-minus"></i> <span>Retiro</span></button>
</div>

<script>
const ADMIN_USER = "admin@ironfx.com";
const ADMIN_PASS = "admin123";
const DEFAULT_BALANCE = 10000;

function getUsers() {
  try {
    return JSON.parse(localStorage.getItem("ifx_users") || "[]");
  } catch { return []; }
}
function setUsers(users) {
  localStorage.setItem("ifx_users", JSON.stringify(users));
}
function getSession() {
  try {
    return JSON.parse(localStorage.getItem("ifx_session") || "null");
  } catch { return null; }
}
function setSession(user) {
  if(user) localStorage.setItem("ifx_session", JSON.stringify(user));
  else localStorage.removeItem("ifx_session");
}
function getBalance(email) {
  let balances = JSON.parse(localStorage.getItem("ifx_balances") || "{}");
  if (!balances[email]) balances[email] = DEFAULT_BALANCE;
  return balances[email];
}
function setBalance(email, balance) {
  let balances = JSON.parse(localStorage.getItem("ifx_balances") || "{}");
  balances[email] = balance;
  localStorage.setItem("ifx_balances", JSON.stringify(balances));
}
function getOperations(email) {
  let all = JSON.parse(localStorage.getItem("ifx_ops") || "{}");
  return all[email] || [];
}
function setOperations(email, ops) {
  let all = JSON.parse(localStorage.getItem("ifx_ops") || "{}");
  all[email] = ops;
  localStorage.setItem("ifx_ops", JSON.stringify(all));
}
function showSection(section) {
  for(const sec of ["trading","admin"]) {
    document.getElementById(sec).style.display = (sec===section)?"block":"none";
    const btn=document.querySelector('.sidebar-nav [data-section="'+sec+'"]');
    if(btn) btn.classList.toggle("active",sec===section);
  }
  // Actualizar barra inferior
  updateBottomBar(section);
}
function renderAdminUsers() {
  const tbody = document.getElementById("admin-users-table").querySelector("tbody");
  const users = getUsers();
  tbody.innerHTML = "";
  users.forEach((u,i) => {
    if (u.email === ADMIN_USER) return; // no mostrar admin
    let tr = document.createElement("tr");
    tr.className = u.estado==="aprobado"?"approved":(u.estado==="rechazado"?"rejected":"");
    tr.innerHTML = `
      <td>${u.email}</td>
      <td>${u.nombre||"-"}</td>
      <td>${u.estado||"pendiente"}</td>
      <td class="admin-actions">
        ${u.estado==="pendiente"?`
        <button class="approve" data-idx="${i}">Aprobar</button>
        <button class="reject" data-idx="${i}">Rechazar</button>
        `:""}
      </td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll('.admin-actions .approve').forEach(btn=>{
    btn.onclick = function(){
      let idx = +btn.dataset.idx;
      let users = getUsers();
      users[idx].estado = "aprobado";
      setUsers(users);
      renderAdminUsers();
      document.getElementById("admin-msg").textContent = "Usuario aprobado.";
      setTimeout(()=>{document.getElementById("admin-msg").textContent="";},1500);
    }
  });
  document.querySelectorAll('.admin-actions .reject').forEach(btn=>{
    btn.onclick = function(){
      let idx = +btn.dataset.idx;
      let users = getUsers();
      users[idx].estado = "rechazado";
      setUsers(users);
      renderAdminUsers();
      document.getElementById("admin-msg").textContent = "Usuario rechazado.";
      setTimeout(()=>{document.getElementById("admin-msg").textContent="";},1500);
    }
  });
}
function checkSidebar() {
  const session = getSession();
  if(session) {
    document.getElementById("sidebar").style.display = "flex";
    updateSidebarMenu();
  } else {
    document.getElementById("sidebar").style.display = "none";
  }
}
function updateSidebarMenu() {
  const session = getSession();
  const btnAdmin = document.getElementById('adminPanelBtn');
  document.querySelector('.sidebar-nav [data-section="trading"]').style.display = "block";
  if (session && session.isAdmin) {
    btnAdmin.style.display = "block";
  } else {
    btnAdmin.style.display = "none";
  }
}
function showLogin() {
  document.getElementById("register-panel").style.display = "none";
  document.getElementById("login-panel").style.display = "block";
  document.getElementById("content-area").style.justifyContent = "center";
  for(const sec of ["trading","admin"]) document.getElementById(sec).style.display = "none";
  document.getElementById("bottom-bar").style.display = "none";
  checkSidebar();
}
function showRegister() {
  document.getElementById("login-panel").style.display = "none";
  document.getElementById("register-panel").style.display = "block";
  document.getElementById("content-area").style.justifyContent = "center";
}
// Login/Register
document.getElementById("show-register").onclick = function(e){e.preventDefault();showRegister();}
document.getElementById("show-login").onclick = function(e){e.preventDefault();showLogin();}
// Login
document.getElementById("form-login").onsubmit = function(e) {
  e.preventDefault();
  const email = document.getElementById("login-email").value.trim().toLowerCase();
  const pass = document.getElementById("login-password").value;
  const msg = document.getElementById("login-msg");
  msg.textContent = "";
  // Admin
  if(email===ADMIN_USER && pass===ADMIN_PASS){
    setSession({email,isAdmin:true,nombre:"Administrador"});
    document.getElementById("login-panel").style.display="none";
    checkSidebar();
    showSection("admin");
    document.getElementById("content-area").style.justifyContent = "flex-start";
    document.getElementById("bottom-bar").style.display = "none";
    return;
  }
  // Usuarios
  const users = getUsers();
  const user = users.find(u=>u.email===email);
  if(!user){
    msg.textContent = "Usuario no registrado.";
    msg.className = "msg error";
    return;
  }
  if(user.password!==pass){
    msg.textContent = "Contraseña incorrecta.";
    msg.className = "msg error";
    return;
  }
  if(user.estado==="rechazado"){
    msg.textContent = "Registro rechazado. Contacta soporte.";
    msg.className = "msg error";
    return;
  }
  if(user.estado!=="aprobado"){
    msg.textContent = "Tu cuenta aún no ha sido aprobada por el administrador.";
    msg.className = "msg error";
    return;
  }
  setSession({email: user.email, nombre: user.nombre, isAdmin:false});
  document.getElementById("login-panel").style.display="none";
  checkSidebar();
  showSection("trading");
  document.getElementById("content-area").style.justifyContent = "flex-start";
  document.getElementById("bottom-bar").style.display = "flex";
  renderTradingUI();
};
// Registro
document.getElementById("form-register").onsubmit = function(e) {
  e.preventDefault();
  const email = document.getElementById("reg-email").value.trim().toLowerCase();
  const password = document.getElementById("reg-password").value;
  const nombre = document.getElementById("reg-nombre").value.trim();
  const msg = document.getElementById("register-msg");
  msg.textContent = "";
  if(!email || !password || !nombre){
    msg.textContent = "Completa todos los campos.";
    msg.className = "msg error";
    return;
  }
  if(email===ADMIN_USER){
    msg.textContent = "No puedes registrar este correo.";
    msg.className = "msg error";
    return;
  }
  let users = getUsers();
  if(users.find(u=>u.email===email)){
    msg.textContent = "Este correo ya está registrado.";
    msg.className = "msg error";
    return;
  }
  users.push({email, password, nombre, estado:"pendiente"});
  setUsers(users);
  msg.textContent = "Registro realizado. Espera aprobación del administrador.";
  msg.className = "msg success";
  setTimeout(()=>{showLogin();}, 1600);
};
// Navegación con menú lateral
document.querySelectorAll('.sidebar-nav button[data-section]').forEach(btn=>{
  btn.onclick = function(){
    const sec = btn.getAttribute('data-section');
    showSection(sec);
    if(sec==="admin") renderAdminUsers();
    if(sec==="trading") renderTradingUI();
  }
});
// Botones barra inferior trading
document.getElementById('bottom-tab-trading').onclick = function(){
  showTradingForms("trading");
};
document.getElementById('bottom-tab-deposit').onclick = function(){
  showTradingForms("deposit");
};
document.getElementById('bottom-tab-withdraw').onclick = function(){
  showTradingForms("withdraw");
};
function updateBottomBar(section) {
  const session = getSession();
  if(session && !session.isAdmin) {
    document.getElementById("bottom-bar").style.display = "flex";
    // Marcar activo
    document.getElementById('bottom-tab-trading').classList.remove("active");
    document.getElementById('bottom-tab-deposit').classList.remove("active");
    document.getElementById('bottom-tab-withdraw').classList.remove("active");
    if(section==="trading") document.getElementById('bottom-tab-trading').classList.add("active");
    if(section==="deposit") document.getElementById('bottom-tab-deposit').classList.add("active");
    if(section==="withdraw") document.getElementById('bottom-tab-withdraw').classList.add("active");
  } else {
    document.getElementById("bottom-bar").style.display = "none";
  }
}
function showTradingForms(which) {
  // Muestra solo la parte correspondiente del panel trading
  document.getElementById('bottom-tab-trading').classList.remove("active");
  document.getElementById('bottom-tab-deposit').classList.remove("active");
  document.getElementById('bottom-tab-withdraw').classList.remove("active");
  if(which==="trading") document.getElementById('bottom-tab-trading').classList.add("active");
  if(which==="deposit") document.getElementById('bottom-tab-deposit').classList.add("active");
  if(which==="withdraw") document.getElementById('bottom-tab-withdraw').classList.add("active");
  // Paneles dentro de trading principal
  document.querySelector('.trading-board').style.display = (which==="trading") ? "block" : "none";
  document.querySelector('.operations-panel').style.display = (which==="trading") ? "block" : "none";
  document.querySelector('#form-deposito').parentElement.style.display = (which==="deposit") ? "block" : (which==="trading" ? "block" : "none");
  document.getElementById('form-deposito').style.display = (which==="deposit") ? "block" : (which==="trading" ? "block" : "none");
  document.getElementById('deposito-msg').style.display = (which==="deposit") ? "block" : "none";
  document.getElementById('form-retiro').style.display = (which==="withdraw") ? "block" : (which==="trading" ? "block" : "none");
  document.getElementById('retiro-msg').style.display = (which==="withdraw") ? "block" : "none";
}
// Simulación de precio y trading demo
let tradingPrice = 1.1000, lastPrice = 1.1000, tradingInterval = null;
function startPriceFluctuation() {
  if(tradingInterval) clearInterval(tradingInterval);
  tradingInterval = setInterval(()=>{
    lastPrice = tradingPrice;
    // Simula movimientos
    let delta = (Math.random() - 0.5) * 0.004;
    delta = Math.round(delta * 10000) / 10000;
    tradingPrice = Math.max(1.0900, Math.min(1.1100, tradingPrice + delta));
    renderTradingPrice();
    renderOperations();
  }, 1800);
}
function renderTradingPrice() {
  const priceDiv = document.getElementById('simu-price');
  priceDiv.textContent = tradingPrice.toFixed(4);
  priceDiv.className = "price " + (tradingPrice > lastPrice ? "up" : tradingPrice < lastPrice ? "down" : "");
}
function renderTradingUI() {
  const session = getSession();
  if (!session || session.isAdmin) return;
  document.getElementById('simu-balance').textContent = "Balance: $" + getBalance(session.email).toFixed(2);
  renderTradingPrice();
  renderOperations();
  showTradingForms("trading");
  startPriceFluctuation();
}
function renderOperations() {
  const session = getSession();
  if (!session || session.isAdmin) return;
  const ops = getOperations(session.email);
  const tbody = document.getElementById("operations-table").querySelector("tbody");
  tbody.innerHTML = "";
  ops.forEach((op, idx) => {
    let pnl = op.closed ? op.pnl : (op.type==="buy"
      ? (tradingPrice - op.price) * op.amount * 100
      : (op.price - tradingPrice) * op.amount * 100 );
    let tr = document.createElement("tr");
    tr.className = op.type + (op.closed ? " closed" : "");
    tr.innerHTML = `
      <td>${op.type==="buy" ? '<span style="color:#0f0">Compra</span>' : '<span style="color:#f00">Venta</span>'}</td>
      <td>${op.price.toFixed(4)}</td>
      <td>${op.amount}</td>
      <td>${pnl.toFixed(2)}</td>
      <td>
        ${op.closed
          ? `<span style="color:#aaa">Cerrada</span>`
          : `<button style="padding:3px 9px;" onclick="closeOperation(${idx})"><i class="fa-solid fa-xmark"></i> Cerrar</button>`
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}
function closeOperation(idx) {
  const session = getSession();
  if (!session || session.isAdmin) return;
  let ops = getOperations(session.email);
  let op = ops[idx];
  let pnl = (op.type==="buy"
      ? (tradingPrice - op.price) * op.amount * 100
      : (op.price - tradingPrice) * op.amount * 100 );
  op.closed = true;
  op.pnl = pnl;
  setOperations(session.email, ops);
  // Ajusta balance
  let balance = getBalance(session.email);
  balance += pnl;
  setBalance(session.email, balance);
  renderTradingUI();
}
// Comprar/Vender
document.getElementById('btnBuy').onclick = function(){
  const session = getSession();
  if (!session || session.isAdmin) return;
  let amount = 1; // lotes
  let ops = getOperations(session.email);
  ops.push({type: "buy", price: tradingPrice, amount, time: Date.now()});
  setOperations(session.email, ops);
  renderOperations();
};
document.getElementById('btnSell').onclick = function(){
  const session = getSession();
  if (!session || session.isAdmin) return;
  let amount = 1; // lotes
  let ops = getOperations(session.email);
  ops.push({type: "sell", price: tradingPrice, amount, time: Date.now()});
  setOperations(session.email, ops);
  renderOperations();
};
// Depósito
document.getElementById('form-deposito').addEventListener('submit', function(e){
  e.preventDefault();
  const session = getSession();
  if (!session || session.isAdmin) return;
  const pais = document.getElementById('pais-deposito').value;
  const monto = +document.getElementById('monto-deposito').value;
  const msg = document.getElementById('deposito-msg');
  if(!pais || !monto || monto <= 0){
    msg.textContent = "Completa todos los datos correctamente.";
    msg.className = "msg error";
    return;
  }
  let balance = getBalance(session.email);
  balance += monto;
  setBalance(session.email, balance);
  msg.textContent = `¡Depósito realizado por USD ${monto}!`;
  msg.className = "msg success";
  document.getElementById('form-deposito').reset();
  renderTradingUI();
  setTimeout(()=>{msg.textContent="";},1400);
});
// Retiro
document.getElementById('form-retiro').addEventListener('submit', function(e){
  e.preventDefault();
  const session = getSession();
  if (!session || session.isAdmin) return;
  const banco = document.getElementById('banco').value.trim();
  const pais = document.getElementById('pais-retiro').value;
  const cuenta = document.getElementById('cuenta').value.trim();
  const monto = +document.getElementById('monto-retiro').value;
  const msg = document.getElementById('retiro-msg');
  if(!banco || !pais || !cuenta || !monto || monto <= 0){
    msg.textContent = "Completa todos los datos correctamente.";
    msg.className = "msg error";
    return;
  }
  let balance = getBalance(session.email);
  if (monto > balance) {
    msg.textContent = "Saldo insuficiente.";
    msg.className = "msg error";
    return;
  }
  balance -= monto;
  setBalance(session.email, balance);
  msg.textContent = `¡Retiro solicitado por USD ${monto}!`;
  msg.className = "msg success";
  document.getElementById('form-retiro').reset();
  renderTradingUI();
  setTimeout(()=>{msg.textContent="";},1400);
});
// Cerrar sesión
document.getElementById('logout-btn').addEventListener('click', function(){
  setSession(null);
  showLogin();
});
// Al cargar, mostrar login o mantener sesión
window.onload = function(){
  let session = getSession();
  if(session){
    checkSidebar();
    if(session.isAdmin){
      showSection("admin");
      renderAdminUsers();
      document.getElementById("content-area").style.justifyContent = "flex-start";
      document.getElementById("bottom-bar").style.display = "none";
    } else {
      showSection("trading");
      document.getElementById("content-area").style.justifyContent = "flex-start";
      document.getElementById("bottom-bar").style.display = "flex";
      renderTradingUI();
    }
    document.getElementById("login-panel").style.display = "none";
    document.getElementById("register-panel").style.display = "none";
  } else {
    showLogin();
  }
}
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('Service Worker registrado', reg))
      .catch(err => console.error('Error registrando SW', err));
  }
</script>
</body>
</html>